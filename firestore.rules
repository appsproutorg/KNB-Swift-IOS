rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userEmail) {
      return isAuthenticated() && request.auth.token.email == userEmail;
    }
    
    // Honors collection - read for authenticated users, write for authenticated users
    match /honors/{honorId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Kiddush Sponsorships - authenticated users can read and create
    match /kiddush_sponsorships/{sponsorshipId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.sponsorEmail == request.auth.token.email;
      allow delete: if isAuthenticated() 
                    && (resource.data.sponsorEmail == request.auth.token.email 
                        || get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.isAdmin == true);
      allow update: if false; // Only allow through admin console
    }
    
    // Available Shabbat Dates - read by all authenticated users
    match /available_shabbat_dates/{dateId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin only through console
    }
    
    // Social Posts - authenticated users can read, create, update own posts
    match /social_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.authorEmail == request.auth.token.email
                    && request.resource.data.content.size() <= 140
                    && request.resource.data.likeCount == 0
                    && request.resource.data.replyCount == 0
                    && (request.resource.data.parentPostId == null || request.resource.data.parentPostId is string);
      allow update: if isAuthenticated() 
                    && (resource.data.authorEmail == request.auth.token.email 
                        || (request.resource.data.authorEmail == resource.data.authorEmail
                            && request.resource.data.content == resource.data.content
                            && request.resource.data.timestamp == resource.data.timestamp
                            && request.resource.data.authorName == resource.data.authorName  // authorName cannot be changed
                            && (request.resource.data.parentPostId == resource.data.parentPostId)
                            && request.resource.data.replyCount >= 0));
      allow delete: if isAuthenticated() 
                    && (resource.data.authorEmail == request.auth.token.email 
                        || get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.isAdmin == true);
    }
    

    
    // Users collection - users can read their own data, create/update their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.email == request.auth.token.email;
      allow update: if isAuthenticated() 
                    && resource.data.email == request.auth.token.email
                    && request.resource.data.email == resource.data.email  // Cannot change email
                    && (!request.resource.data.keys().hasAny(['isAdmin']) 
                        || request.resource.data.isAdmin == resource.data.isAdmin  // Cannot change isAdmin unless already admin
                        || get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.isAdmin == true)
                    && (!request.resource.data.keys().hasAny(['name']) 
                        || (request.resource.data.name is string 
                            && request.resource.data.name.size() >= 3 
                            && request.resource.data.name.size() <= 50));  // Name validation: 3-50 chars
      
      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.token.email == userId;
        allow write: if isAuthenticated() && request.auth.token.email == userId;
      }
    }
    

  }
}

