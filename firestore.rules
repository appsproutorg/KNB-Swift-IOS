rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the Super Admin
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.email.lower() == 'admin@knb.com';
    }

    // Helper function to check if user is an Admin
    function isAdmin() {
      return isSuperAdmin() || 
             (isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.isAdmin == true);
    }
    
    // Honors collection
    match /honors/{honorId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin(); // Only admins can create honors
      allow update: if isAuthenticated() 
                    && (isAdmin() 
                        || (
                           // Non-admins can only update bids, currentBid, and currentWinner
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bids', 'currentBid', 'currentWinner'])
                           && request.resource.data.currentBid > resource.data.currentBid // Bid must increase
                           && request.resource.data.bids.size() == resource.data.bids.size() + 1 // Must add exactly one bid
                        ));
      allow delete: if isAdmin(); // Only admins can delete
    }
    
    // Kiddush Sponsorships
    match /kiddush_sponsorships/{sponsorshipId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.sponsorEmail == request.auth.token.email;
      allow delete: if isAuthenticated() 
                    && (resource.data.sponsorEmail == request.auth.token.email 
                        || isAdmin());
      allow update: if isAdmin(); // Allow admins to mark as paid etc
    }
    
    // Available Shabbat Dates
    match /available_shabbat_dates/{dateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Social Posts
    match /social_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.authorEmail == request.auth.token.email
                    && request.resource.data.content.size() <= 140
                    && request.resource.data.likeCount == 0
                    && request.resource.data.replyCount == 0
                    && (request.resource.data.parentPostId == null || request.resource.data.parentPostId is string);
      allow update: if isAuthenticated() 
                    && (resource.data.authorEmail == request.auth.token.email 
                        || (request.resource.data.authorEmail == resource.data.authorEmail
                            && request.resource.data.content == resource.data.content
                            && request.resource.data.timestamp == resource.data.timestamp
                            && request.resource.data.authorName == resource.data.authorName
                            && (request.resource.data.parentPostId == resource.data.parentPostId)
                            && request.resource.data.replyCount >= 0));
      allow delete: if isAuthenticated() 
                    && (resource.data.authorEmail == request.auth.token.email 
                        || isAdmin());
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.email == request.auth.token.email;
      allow update: if isAuthenticated() 
                    && (
                      // User updating their own profile (cannot change email or isAdmin)
                      (resource.data.email == request.auth.token.email
                       && request.resource.data.email == resource.data.email
                       && request.resource.data.isAdmin == resource.data.isAdmin)
                      ||
                      // Super Admin can update anything (including making others admin)
                      isSuperAdmin()
                    );
      
      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.token.email == userId;
        allow write: if isAuthenticated() && request.auth.token.email == userId;
      }
    }
  }
}

