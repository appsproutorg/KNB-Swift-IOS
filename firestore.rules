rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the Super Admin
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.email.lower() == 'admin@knb.com';
    }

    // Helper function to check if user is an Admin
    function isAdmin() {
      return isSuperAdmin() || 
             (isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.isAdmin == true);
    }
    
    function validSocialMediaItem(media) {
      return media is map
             && media.keys().hasOnly(['type', 'storagePath', 'downloadURL', 'width', 'height', 'fileSizeBytes'])
             && media.type == 'image'
             && media.storagePath is string
             && media.downloadURL is string
             && media.width is int
             && media.height is int
             && media.fileSizeBytes is int
             && media.width > 0
             && media.height > 0
             && media.fileSizeBytes > 0
             && media.fileSizeBytes < 3 * 1024 * 1024;
    }

    function validLegacySocialMedia(media) {
      return media == null || validSocialMediaItem(media);
    }

    function validSocialMediaItems(mediaItems) {
      return mediaItems == null ||
             (mediaItems is list
              && mediaItems.size() <= 4
              && (mediaItems.size() < 1 || validSocialMediaItem(mediaItems[0]))
              && (mediaItems.size() < 2 || validSocialMediaItem(mediaItems[1]))
              && (mediaItems.size() < 3 || validSocialMediaItem(mediaItems[2]))
              && (mediaItems.size() < 4 || validSocialMediaItem(mediaItems[3])));
    }

    function hasAnySocialMedia(data) {
      return ((data.mediaItems is list && data.mediaItems.size() > 0 && validSocialMediaItems(data.mediaItems))
              || (data.media is map && validSocialMediaItem(data.media)));
    }

    function canAddOwnLike() {
      return !resource.data.likes.hasAny([request.auth.token.email])
             && request.resource.data.likes.hasAny([request.auth.token.email])
             && request.resource.data.likes.size() == resource.data.likes.size() + 1
             && request.resource.data.likes.hasAll(resource.data.likes);
    }

    function canRemoveOwnLike() {
      return resource.data.likes.hasAny([request.auth.token.email])
             && !request.resource.data.likes.hasAny([request.auth.token.email])
             && request.resource.data.likes.size() == resource.data.likes.size() - 1
             && resource.data.likes.hasAll(request.resource.data.likes);
    }

    function canToggleOnlyOwnLike() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likeCount'])
             && request.resource.data.likes is list
             && resource.data.likes is list
             && request.resource.data.likeCount == request.resource.data.likes.size()
             && (canAddOwnLike() || canRemoveOwnLike());
    }

    function isRabbiEmail(email) {
      return email is string
             && (email.lower() == 'acagishtein@gmail.com'
                 || email.lower() == 'acagishtein@googlemail.com'
                 || email.lower() == 'ethangoizman16@googlemail.com'
                 || email.lower() == 'ethangoizman16@gmail.com');
    }

    function isCurrentUserRabbi() {
      return isAuthenticated() && isRabbiEmail(request.auth.token.email);
    }

    function validRabbiRecipients(recipients) {
      return recipients is list
             && recipients.size() == 2
             && recipients[0] is string
             && recipients[1] is string
             && (
               (recipients[0].lower() == 'acagishtein@gmail.com' && recipients[1].lower() == 'ethangoizman16@gmail.com')
               || (recipients[0].lower() == 'ethangoizman16@gmail.com' && recipients[1].lower() == 'acagishtein@gmail.com')
             );
    }

    // Shared Kiddush calendar (public read-only)
    match /kiddushCalendar/{isoDate} {
      allow read: if true;
      allow write: if false;
    }

    // Sync metadata must stay private
    match /kiddushMeta/{docId} {
      allow read, write: if false;
    }

    // Community occasions (app read-only)
    match /communityOccasions/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Community sync metadata must stay private
    match /communityMeta/{docId} {
      allow read, write: if false;
    }

    // Daily calendar docs (app read-only)
    match /dailyCalendar/{isoDate} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Daily calendar sync metadata stays private
    match /dailyCalendarMeta/{docId} {
      allow read, write: if false;
    }

    // Honors collection
    match /honors/{honorId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin(); // Only admins can create honors
      allow update: if isAuthenticated() 
                    && (isAdmin() 
                        || (
                           // Non-admins can only update bids, currentBid, and currentWinner
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bids', 'currentBid', 'currentWinner', 'isSold'])
                           && (resource.data.isSold == false || !(resource.data.isSold is bool))
                           && request.resource.data.currentBid > resource.data.currentBid // Bid must increase
                           && request.resource.data.bids.size() == resource.data.bids.size() + 1 // Must add exactly one bid
                           && (request.resource.data.isSold == resource.data.isSold || request.resource.data.isSold == true)
                        ));
      allow delete: if isAdmin(); // Only admins can delete
    }
    
    // Kiddush Sponsorships
    match /kiddush_sponsorships/{sponsorshipId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.sponsorEmail == request.auth.token.email
                    && request.resource.data.keys().hasOnly([
                      'id', 'date', 'sponsorName', 'sponsorEmail', 'occasion',
                      'tierName', 'tierAmount', 'isAnonymous', 'timestamp', 'isPaid'
                    ])
                    && request.resource.data.id is string
                    && request.resource.data.date is timestamp
                    && request.resource.data.sponsorName is string
                    && request.resource.data.sponsorName.size() > 0
                    && request.resource.data.sponsorEmail is string
                    && request.resource.data.occasion is string
                    && request.resource.data.tierName is string
                    && request.resource.data.tierAmount is int
                    && request.resource.data.isAnonymous is bool
                    && request.resource.data.timestamp is timestamp
                    && request.resource.data.isPaid == false;
      allow delete: if isAuthenticated() 
                    && (resource.data.sponsorEmail == request.auth.token.email 
                        || isAdmin());
      allow update: if isAdmin(); // Allow admins to mark as paid etc
    }
    
    // Available Shabbat Dates
    match /available_shabbat_dates/{dateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Social Posts
    match /social_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.authorEmail == request.auth.token.email
                    && request.resource.data.authorName is string
                    && request.resource.data.authorName.size() > 0
                    && request.resource.data.authorName.size() <= 80
                    && request.resource.data.content is string
                    && request.resource.data.content.size() <= 140
                    && (request.resource.data.content.size() > 0 || hasAnySocialMedia(request.resource.data))
                    && request.resource.data.likeCount == 0
                    && request.resource.data.replyCount == 0
                    && (request.resource.data.parentPostId == null || request.resource.data.parentPostId is string)
                    && validSocialMediaItems(request.resource.data.mediaItems)
                    && validLegacySocialMedia(request.resource.data.media);
      allow update: if isAuthenticated() 
                    && (
                        (
                          resource.data.authorEmail == request.auth.token.email
                          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'editedAt'])
                          && request.resource.data.content is string
                          && request.resource.data.content.size() <= 140
                          && (request.resource.data.content.size() > 0 || hasAnySocialMedia(request.resource.data))
                        )
                        ||
                        canToggleOnlyOwnLike()
                      );
      allow delete: if isAuthenticated() 
                    && (resource.data.authorEmail == request.auth.token.email 
                        || isAdmin());
    }

    // Rabbi chat messages
    match /rabbi_messages/{messageId} {
      allow read: if isAuthenticated()
                  && (
                    (resource.data.threadOwnerEmail is string
                     && resource.data.threadOwnerEmail.lower() == request.auth.token.email.lower())
                    || isCurrentUserRabbi()
                  );
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasOnly([
                      'threadOwnerEmail',
                      'content',
                      'timestamp',
                      'recipientEmails',
                      'senderEmail',
                      'senderName'
                    ])
                    && request.resource.data.threadOwnerEmail is string
                    && request.resource.data.threadOwnerEmail.size() > 0
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 1000
                    && request.resource.data.timestamp is timestamp
                    && validRabbiRecipients(request.resource.data.recipientEmails)
                    && (
                      !request.resource.data.keys().hasAny(['senderEmail'])
                      || (
                        request.resource.data.senderEmail is string
                        && request.resource.data.senderEmail.lower() == request.auth.token.email.lower()
                      )
                    )
                    && (
                      !request.resource.data.keys().hasAny(['senderName'])
                      || (
                        request.resource.data.senderName is string
                        && request.resource.data.senderName.size() > 0
                        && request.resource.data.senderName.size() <= 120
                      )
                    )
                    && (
                      isCurrentUserRabbi()
                      || request.resource.data.threadOwnerEmail.lower() == request.auth.token.email.lower()
                    );
      allow update, delete: if false;
    }

    // Public chat directory (authenticated read)
    match /chat_directory/{emailDoc} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated()
                            && request.auth.token.email is string
                            && (
                              emailDoc.lower() == request.auth.token.email.lower()
                              || isAdmin()
                            )
                            && request.resource.data.keys().hasOnly(['email', 'name', 'lastUpdated'])
                            && request.resource.data.email is string
                            && request.resource.data.email.lower() == emailDoc.lower()
                            && request.resource.data.name is string
                            && request.resource.data.name.size() > 0
                            && request.resource.data.name.size() <= 120
                            && request.resource.data.lastUpdated is timestamp;
      allow delete: if false;
    }

    // Direct messages between any two authenticated users
    match /direct_messages/{messageId} {
      allow read: if isAuthenticated()
                  && request.auth.token.email is string
                  && resource.data.participants.hasAny([request.auth.token.email.lower()]);
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasOnly([
                      'threadId',
                      'participants',
                      'senderEmail',
                      'senderName',
                      'recipientEmail',
                      'recipientName',
                      'content',
                      'timestamp'
                    ])
                    && request.resource.data.threadId is string
                    && request.resource.data.threadId.size() > 0
                    && request.resource.data.participants is list
                    && request.resource.data.participants.size() == 2
                    && request.resource.data.participants[0] is string
                    && request.resource.data.participants[1] is string
                    && request.resource.data.participants.hasAny([request.auth.token.email.lower()])
                    && request.resource.data.senderEmail is string
                    && request.resource.data.senderEmail.lower() == request.auth.token.email.lower()
                    && request.resource.data.senderName is string
                    && request.resource.data.senderName.size() > 0
                    && request.resource.data.senderName.size() <= 120
                    && request.resource.data.recipientEmail is string
                    && request.resource.data.recipientName is string
                    && request.resource.data.recipientName.size() > 0
                    && request.resource.data.recipientName.size() <= 120
                    && request.resource.data.senderEmail.lower() != request.resource.data.recipientEmail.lower()
                    && request.resource.data.participants.hasAll([
                      request.resource.data.senderEmail.lower(),
                      request.resource.data.recipientEmail.lower()
                    ])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 1000
                    && request.resource.data.timestamp is timestamp;
      allow update: if false;
      allow delete: if isAuthenticated()
                    && request.auth.token.email is string
                    && (
                      (resource.data.participants is list
                       && resource.data.participants.hasAny([request.auth.token.email.lower()]))
                      || (resource.data.senderEmail is string
                          && resource.data.senderEmail.lower() == request.auth.token.email.lower())
                      || (resource.data.recipientEmail is string
                          && resource.data.recipientEmail.lower() == request.auth.token.email.lower())
                    );
    }
    
    // Seat Reservations
    match /seat_reservations/{seatId} {
      allow read: if isAuthenticated(); // Everyone can see which seats are reserved
      allow create: if isAuthenticated() 
                    && request.resource.data.reservedBy == request.auth.token.email
                    && request.resource.data.reservedByName is string
                    && request.resource.data.row is string
                    && request.resource.data.number is int
                    && request.resource.data.timestamp is timestamp;
      allow delete: if isAuthenticated() 
                    && (resource.data.reservedBy == request.auth.token.email 
                        || isAdmin());
      allow update: if false; // No updates allowed - only create/delete
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && userId == request.auth.token.email
                    && request.resource.data.email == request.auth.token.email
                    && (!request.resource.data.keys().hasAny(['isAdmin']) || request.resource.data.isAdmin == false);
      allow update: if isAuthenticated() 
                    && (
                      // User updating their own profile (cannot change email or isAdmin)
                      (resource.data.email == request.auth.token.email
                       && request.resource.data.email == resource.data.email
                       && request.resource.data.isAdmin == resource.data.isAdmin
                       && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                         'name', 'notificationPrefs', 'lastUpdated', 'fcmTokens',
                         'fcmToken', 'fcmTokenUpdatedAt'
                       ]))
                      ||
                      // Super Admin can update anything (including making others admin)
                      isSuperAdmin()
                    );
      
      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.token.email == userId;
        allow write: if isAuthenticated() && request.auth.token.email == userId;
      }
    }
  }
}
