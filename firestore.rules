rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the Super Admin
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.email.lower() == 'admin@knb.com';
    }

    // Helper function to check if user is an Admin
    function isAdmin() {
      return isSuperAdmin() || 
             (isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.isAdmin == true);
    }
    
    function validSocialMediaItem(media) {
      return media is map
             && media.keys().hasOnly(['type', 'storagePath', 'downloadURL', 'width', 'height', 'fileSizeBytes'])
             && media.type == 'image'
             && media.storagePath is string
             && media.downloadURL is string
             && media.width is int
             && media.height is int
             && media.fileSizeBytes is int
             && media.width > 0
             && media.height > 0
             && media.fileSizeBytes > 0
             && media.fileSizeBytes < 3 * 1024 * 1024;
    }

    function validLegacySocialMedia(media) {
      return media == null || validSocialMediaItem(media);
    }

    function validSocialMediaItems(mediaItems) {
      return mediaItems == null ||
             (mediaItems is list
              && mediaItems.size() <= 4
              && (mediaItems.size() < 1 || validSocialMediaItem(mediaItems[0]))
              && (mediaItems.size() < 2 || validSocialMediaItem(mediaItems[1]))
              && (mediaItems.size() < 3 || validSocialMediaItem(mediaItems[2]))
              && (mediaItems.size() < 4 || validSocialMediaItem(mediaItems[3])));
    }

    function hasAnySocialMedia(data) {
      return ((data.mediaItems is list && data.mediaItems.size() > 0 && validSocialMediaItems(data.mediaItems))
              || (data.media is map && validSocialMediaItem(data.media)));
    }

    // Shared Kiddush calendar (public read-only)
    match /kiddushCalendar/{isoDate} {
      allow read: if true;
      allow write: if false;
    }

    // Sync metadata must stay private
    match /kiddushMeta/{docId} {
      allow read, write: if false;
    }
    
    // Honors collection
    match /honors/{honorId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin(); // Only admins can create honors
      allow update: if isAuthenticated() 
                    && (isAdmin() 
                        || (
                           // Non-admins can only update bids, currentBid, and currentWinner
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bids', 'currentBid', 'currentWinner'])
                           && request.resource.data.currentBid > resource.data.currentBid // Bid must increase
                           && request.resource.data.bids.size() == resource.data.bids.size() + 1 // Must add exactly one bid
                        ));
      allow delete: if isAdmin(); // Only admins can delete
    }
    
    // Kiddush Sponsorships
    match /kiddush_sponsorships/{sponsorshipId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.sponsorEmail == request.auth.token.email;
      allow delete: if isAuthenticated() 
                    && (resource.data.sponsorEmail == request.auth.token.email 
                        || isAdmin());
      allow update: if isAdmin(); // Allow admins to mark as paid etc
    }
    
    // Available Shabbat Dates
    match /available_shabbat_dates/{dateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Social Posts
    match /social_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.authorEmail == request.auth.token.email
                    && request.resource.data.content is string
                    && request.resource.data.content.size() <= 140
                    && (request.resource.data.content.size() > 0 || hasAnySocialMedia(request.resource.data))
                    && request.resource.data.likeCount == 0
                    && request.resource.data.replyCount == 0
                    && (request.resource.data.parentPostId == null || request.resource.data.parentPostId is string)
                    && validSocialMediaItems(request.resource.data.mediaItems)
                    && validLegacySocialMedia(request.resource.data.media);
      allow update: if isAuthenticated() 
                    && (
                        (
                          resource.data.authorEmail == request.auth.token.email
                          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'editedAt'])
                          && request.resource.data.content is string
                          && request.resource.data.content.size() <= 140
                          && (request.resource.data.content.size() > 0 || hasAnySocialMedia(request.resource.data))
                        )
                        ||
                        (
                          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likeCount', 'replyCount'])
                          && request.resource.data.likeCount >= 0
                          && request.resource.data.replyCount >= 0
                        )
                      );
      allow delete: if isAuthenticated() 
                    && (resource.data.authorEmail == request.auth.token.email 
                        || isAdmin());
    }
    
    // Seat Reservations
    match /seat_reservations/{seatId} {
      allow read: if isAuthenticated(); // Everyone can see which seats are reserved
      allow create: if isAuthenticated() 
                    && request.resource.data.reservedBy == request.auth.token.email
                    && request.resource.data.reservedByName is string
                    && request.resource.data.row is string
                    && request.resource.data.number is int
                    && request.resource.data.timestamp is timestamp;
      allow delete: if isAuthenticated() 
                    && (resource.data.reservedBy == request.auth.token.email 
                        || isAdmin());
      allow update: if false; // No updates allowed - only create/delete
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.email == request.auth.token.email;
      allow update: if isAuthenticated() 
                    && (
                      // User updating their own profile (cannot change email or isAdmin)
                      (resource.data.email == request.auth.token.email
                       && request.resource.data.email == resource.data.email
                       && request.resource.data.isAdmin == resource.data.isAdmin)
                      ||
                      // Super Admin can update anything (including making others admin)
                      isSuperAdmin()
                    );
      
      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.token.email == userId;
        allow write: if isAuthenticated() && request.auth.token.email == userId;
      }
    }
  }
}
